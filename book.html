<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail knihy</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="css/stylesheet.css" rel="stylesheet">
</head>

<body>

<div id="paperGrain"></div>
<div id="dynamicBg"></div>
<div id="reading-progress"></div>

<div class="container py-5">

  <!-- Logo -->
  <div class="text-center mt-4 mb-4 logo" style="cursor:pointer;">
    <img id="logoClick" src="images/albatrosmedia_logo.svg" class="book-img" alt="Albatros logo">
  </div>

  <!-- Book header -->
  <div class="text-center mb-4">

    <img src="" id="bookCover" class="book-cover mb-3" alt="Book Cover">

    <div id="coverPlaceholder" class="cover-placeholder">
      <i class="bi bi-book"></i>
    </div>

    <h1></h1>
    <h5 class="text-muted"></h5>
  </div>

  <!-- Chapter content -->
  <div id="content" class="chapter-content"></div>

</div>

<!-- Bottom Toolbar – always visible -->
<div id="bottom-toolbar" class="toolbar-fixed">
  <button id="homeBtn" class="icon-btn"><i class="bi bi-house"></i></button>
  <button id="zoomOutBtn" class="icon-btn"><i class="bi bi-dash-circle"></i></button>
  <button id="zoomInBtn" class="icon-btn"><i class="bi bi-plus-circle"></i></button>
  <button id="themeBtn" class="icon-btn"><i class="bi bi-moon"></i></button>
  <button id="buyBtn" class="icon-btn"><i class="bi bi-cart2"></i></button>

  <a id="buyFullBtn" class="btn btn-primary" target="_blank">
    Kúpiť knihu
  </a>
</div>

<footer class="sticky-footer">
  2026 © Albatros Media Slovakia s.r.o.
</footer>


<script>
//Dynamic background extractor
async function applyDynamicBackground(src) {
  const img = new Image();
  img.crossOrigin = "Anonymous";
  img.src = src;

  img.onload = () => {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

    let r = 0, g = 0, b = 0, count = 0;
    for (let i = 0; i < data.length; i += 40) {
      r += data[i];
      g += data[i + 1];
      b += data[i + 2];
      count++;
    }

    r = Math.floor(r / count);
    g = Math.floor(g / count);
    b = Math.floor(b / count);

    document.getElementById("dynamicBg").style.background =
      `radial-gradient(circle at 30% 30%, rgba(${r},${g},${b},0.4), #fafafa 60%)`;
  };
}


//SCROLL STORAGE
function saveScrollPosition(bookId) {
  localStorage.setItem("scrollPos_" + bookId, window.scrollY);
}

function loadScrollPosition(bookId) {
  const pos = localStorage.getItem("scrollPos_" + bookId);
  if (pos) {
    setTimeout(() => {
      window.scrollTo({ top: parseFloat(pos), behavior: "smooth" });
    }, 150);
  }
}


// LOAD BOOK
async function loadBook() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  const content = document.getElementById("content");
  const coverImg = document.getElementById("bookCover");
  const coverPlaceholder = document.getElementById("coverPlaceholder");

  if (!id) {
    content.textContent = "Kniha nebola nájdená.";
    coverImg.style.display = "none";
    coverPlaceholder.style.display = "flex";
    return;
  }

  const response = await fetch("books.json");
  const books = await response.json();
  const book = books[id];

  if (!book) {
    document.querySelector("h1").textContent = "Kniha neexistuje.";
    document.querySelector(".text-muted").textContent = "";
    content.innerHTML = "";
    coverImg.style.display = "none";
    coverPlaceholder.style.display = "flex";
    return;
  }

  if (book.public !== "1") {
    content.innerHTML = `
      <div class="alert alert-warning text-center">
        Tento titul ešte nie je dostupný na zobrazenie.
      </div>`;
    coverImg.style.display = "none";
    coverPlaceholder.style.display = "flex";
    return;
  }

  document.querySelector("h1").textContent = book.title;
  document.querySelector(".text-muted").textContent = book.author;
  document.title = book.title;

  if (book.cover && book.cover.trim() !== "") {
    coverImg.src = book.cover;
    coverImg.style.display = "block";
    coverPlaceholder.style.display = "none";
    applyDynamicBackground(book.cover);
  } else {
    coverImg.style.display = "none";
    coverPlaceholder.style.display = "flex";
  }

  const chapterHTML = await fetch(book.chapter).then(r => r.text());
  content.innerHTML = chapterHTML;

  document.getElementById("buyBtn").onclick = () => window.open(book.buy, "_blank");
  document.getElementById("buyFullBtn").onclick = () => window.open(book.buy, "_blank");

  //Apply saved font size
  const savedFont = localStorage.getItem("readerFontSize");
  if (savedFont) content.style.fontSize = savedFont + "px";

  //Restore scroll
  loadScrollPosition(id);

  //Save scroll on every scroll
  window.addEventListener("scroll", () => saveScrollPosition(id));
}

loadBook();


// Scroll logic
window.addEventListener("scroll", () => {
  const scrollTop = window.scrollY;
  const docHeight = document.documentElement.scrollHeight - window.innerHeight;
  const progress = (scrollTop / docHeight) * 100;
  document.getElementById("reading-progress").style.width = progress + "%";

  const btnZoomOut = document.getElementById("zoomOutBtn");
  const btnZoomIn = document.getElementById("zoomInBtn");
  const btnTheme = document.getElementById("themeBtn");
  const btnBuy = document.getElementById("buyBtn");
  const btnFullBuy = document.getElementById("buyFullBtn");

  const scrollPos = window.scrollY + window.innerHeight;
  const bottom = document.body.offsetHeight;

  if (scrollPos >= bottom - window.innerHeight * 0.15) {
    btnZoomOut.style.display = "none";
    btnZoomIn.style.display = "none";
    btnTheme.style.display = "none";
    btnBuy.style.display = "none";
    btnFullBuy.style.display = "flex";
  } else {
    btnZoomOut.style.display = "flex";
    btnZoomIn.style.display = "flex";
    btnTheme.style.display = "flex";
    btnBuy.style.display = "flex";
    btnFullBuy.style.display = "none";
  }
});


// Zoom
function adjustZoom(change) {
  const content = document.getElementById("content");

  const docHeightBefore = document.documentElement.scrollHeight - window.innerHeight;
  const ratio = docHeightBefore > 0 ? window.scrollY / docHeightBefore : 0;

  const currentSize = parseFloat(getComputedStyle(content).fontSize);
  const newSize = currentSize + change;

  //Save zoom
  localStorage.setItem("readerFontSize", newSize);

  content.style.fontSize = newSize + "px";

  setTimeout(() => {
    const docHeightAfter = document.documentElement.scrollHeight - window.innerHeight;
    const newScroll = ratio * docHeightAfter;

    window.scrollTo({
      top: newScroll,
      behavior: "smooth"
    });
  }, 20);
}

document.getElementById("zoomInBtn").onclick = () => adjustZoom(+2);
document.getElementById("zoomOutBtn").onclick = () => adjustZoom(-2);


// Theme
function applySavedTheme() {
  const saved = localStorage.getItem("readerTheme");

  if (saved === "dark") {
    document.body.classList.add("dark-mode");
    document.querySelector("#themeBtn i")
      .classList.replace("bi-moon", "bi-brightness-high");
  }
}
applySavedTheme();

document.getElementById("themeBtn").onclick = () => {
  document.body.classList.toggle("dark-mode");

  const icon = document.querySelector("#themeBtn i");
  const isDark = document.body.classList.contains("dark-mode");

  if (isDark) {
    icon.classList.replace("bi-moon", "bi-brightness-high");
    localStorage.setItem("readerTheme", "dark");
  } else {
    icon.classList.replace("bi-brightness-high", "bi-moon");
    localStorage.setItem("readerTheme", "light");
  }
};


// Home button
document.getElementById("homeBtn").onclick = () => {
  window.location.href = "index.html";
};

// Logo click
document.querySelector(".logo").onclick = () => {
  window.location.href = "index.html";
};
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
